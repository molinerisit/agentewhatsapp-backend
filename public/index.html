<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhatsApp Minimal</title>
  <style>
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system; background:#0b0f14; color:#e5e7eb; }
    .app { display:grid; grid-template-columns: 320px 1fr; gap:12px; height:100vh; padding:12px; box-sizing:border-box; }
    .card { background:#0f1720; border:1px solid #1f2937; border-radius:14px; padding:12px; }
    .row { display:flex; gap:8px; align-items:center; }
    input, select, button, textarea { background:#0b1220; color:#e5e7eb; border:1px solid #243042; border-radius:8px; padding:8px; }
    button { background:#10b981; border:0; cursor:pointer; }
    button.secondary { background:#374151; }
    .list { overflow:auto; height: calc(100vh - 160px); display:flex; flex-direction:column; gap:6px; padding-right:6px; }
    .item { padding:8px; border-radius:10px; background:#0b1220; cursor:pointer; }
    .item.active { background:#1f2937; }
    .messages { overflow:auto; height: calc(100vh - 220px); display:flex; flex-direction:column; gap:8px; }
    .bubble { max-width:70%; padding:8px 10px; border-radius:14px; }
    .me { margin-left:auto; background:#047857; }
    .them { background:#111827; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted { opacity: .7; font-size: 12px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="row">
        <input id="backend" placeholder="Backend URL" style="flex:1" />
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="instance" placeholder="Instance name (ej: brand_1)" style="flex:1" />
        <button id="load">Cargar</button>
      </div>
      <div class="muted" style="margin-top:8px;">Consejo: configurá el Webhook en Evolution a <span class="mono">[BACKEND]/api/webhook?token=evolution&instance={{instance}}</span> para recibir en tiempo real.</div>
      <div id="chats" class="list" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <div class="row">
        <div id="status" class="muted">Sin instancia…</div>
        <div style="margin-left:auto;">
          <button id="refresh" class="secondary">Refrescar</button>
        </div>
      </div>

      <div id="messages" class="messages" style="margin-top:8px;"></div>

      <form id="composer" class="row" style="margin-top:8px;">
        <input id="to" placeholder="JID o número (+549...)" style="width:260px;" />
        <input id="text" placeholder="Escribe un mensaje…" style="flex:1" />
        <button>Enviar</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-wfQp5qMZ+R0sxU/MSQm6k4baqhN1xJrxc3c5cEpBkOcnxZr9aH45u3CkqtdbB8YV" crossorigin="anonymous"></script>
  <script>
    const $ = (id) => document.getElementById(id);

    const state = {
      backend: '',
      instance: '',
      chats: [],
      activeJid: null,
      messages: []
    };

    function chatName(c) {
      return c?.name || c?.pushName || c?.subject || c?.id || c?.jid || c?.chatId || c?.key?.remoteJid || '';
    }
    function chatJid(c) {
      return c?.id || c?.jid || c?.chatId || c?.key?.remoteJid || '';
    }
    function extractText(m) {
      const msg = m?.message || m;
      return (msg?.conversation ||
              msg?.extendedTextMessage?.text ||
              msg?.imageMessage?.caption ||
              msg?.videoMessage?.caption ||
              msg?.buttonsResponseMessage?.selectedDisplayText ||
              msg?.listResponseMessage?.title ||
              '');
    }

    function renderChats() {
      const el = $('chats');
      el.innerHTML = '';
      state.chats.forEach((c, i) => {
        const jid = chatJid(c);
        const name = chatName(c) || jid;
        const d = document.createElement('div');
        d.className = 'item' + (state.activeJid === jid ? ' active' : '');
        d.textContent = name;
        d.onclick = async () => {
          state.activeJid = jid;
          await loadMessages();
          render();
        };
        el.appendChild(d);
      });
    }

    function renderMessages() {
      const el = $('messages');
      el.innerHTML = '';
      state.messages.forEach((m, i) => {
        const fromMe = m?.key?.fromMe || m?.fromMe;
        const text = extractText(m) || '⟂ mensaje sin texto';
        const b = document.createElement('div');
        b.className = 'bubble ' + (fromMe ? 'me' : 'them');
        b.textContent = text;
        el.appendChild(b);
      });
      el.scrollTop = el.scrollHeight;
    }

    function render() {
      $('status').textContent = state.instance ? 'Instancia: ' + state.instance : 'Sin instancia…';
      renderChats();
      renderMessages();
      $('to').value = state.activeJid || '';
    }

    async function fetchJSON(url, opts) {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function loadChats() {
      const url = `${state.backend}/api/chats?instance=${encodeURIComponent(state.instance)}`;
      const { chats } = await fetchJSON(url);
      state.chats = Array.isArray(chats) ? chats : [];
    }

    async function loadMessages() {
      if (!state.activeJid) { state.messages = []; return; }
      const url = `${state.backend}/api/messages?instance=${encodeURIComponent(state.instance)}&remoteJid=${encodeURIComponent(state.activeJid)}&limit=50`;
      const { messages } = await fetchJSON(url);
      state.messages = Array.isArray(messages) ? messages : [];
    }

    async function sendMessage() {
      const to = $('to').value.trim();
      const text = $('text').value.trim();
      if (!to || !text) return;
      const body = { instance: state.instance, number: to, text };
      $('text').value = '';
      // optimistic
      state.messages.push({ key: { id: 'tmp-'+Date.now(), remoteJid: to, fromMe: true }, message: { conversation: text } });
      renderMessages();
      try {
        await fetchJSON(`${state.backend}/api/send`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      } catch (e) {
        console.error(e);
      }
    }

    $('load').onclick = async () => {
      state.backend = $('backend').value.trim();
      state.instance = $('instance').value.trim();
      if (!state.backend || !state.instance) return;
      await loadChats();
      render();

      // socket
      const socket = io(state.backend, { transports: ['websocket'] });
      socket.emit('join', { instance: state.instance });
      socket.on('evolution_event', ({ instance, event, payload }) => {
        if (instance !== state.instance) return;
        if (event === 'MESSAGES_UPSERT') {
          const incoming = payload?.data || payload?.messages || payload?.message || payload;
          const msgs = Array.isArray(incoming?.messages) ? incoming.messages : (Array.isArray(incoming) ? incoming : []);
          if (msgs.length) {
            const same = state.activeJid ? msgs.filter(m => (m?.key?.remoteJid) === state.activeJid) : [];
            if (same.length) {
              state.messages = state.messages.concat(same);
              renderMessages();
            }
          }
        }
      });
    };

    $('refresh').onclick = async () => {
      if (!state.backend || !state.instance) return;
      await loadChats();
      await loadMessages();
      render();
    };

    $('composer').onsubmit = async (e) => {
      e.preventDefault();
      await sendMessage();
    };

    // Prefill backend from location
    $('backend').value = location.origin;
  </script>
</body>
</html>
